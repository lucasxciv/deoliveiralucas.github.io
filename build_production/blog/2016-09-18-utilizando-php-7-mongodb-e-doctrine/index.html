<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="Utilizando PHP 7, MongoDB e Doctrine">

        <meta property="og:title" content="Utilizando PHP 7, MongoDB e Doctrine | @lucasxciv"/>
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://lucasxciv.dev/blog/2016-09-18-utilizando-php-7-mongodb-e-doctrine"/>
        <meta property="og:description" content="Utilizando PHP 7, MongoDB e Doctrine" />

        <title>Utilizando PHP 7, MongoDB e Doctrine | @lucasxciv</title>

        <link rel="home" href="https://lucasxciv.dev">
        <link rel="icon" href="/assets/img/logo.jpeg">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="@lucasxciv Atom Feed">

                    <!-- Insert analytics code here -->
        
        <link rel="stylesheet" href="/assets/build/css/main.css?id=63adab265308ca0d59e018de30ed4785">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-base3 text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-base2 py-4" role="banner">
            <div class="container flex items-center max-w-5xl mx-auto px-4 lg:px-8">
                <div id="vue-search" class="grid mx-auto text-center">
                    <div class="text-center items-center justify-center">
                        <img class="h-20 mx-auto shadow border-solid border-4 border-base3 rounded-full" src="/assets/img/logo.jpeg" alt="@lucasxciv logo" />
                    </div>
                    <div class="mt-2">
                        <h1 class="text-2xl text-base01 font-semibold my-0">Lucas de Oliveira</h1>
                        <h1 class="text-xs text-base01 font-semibold my-0">software developer</h1>
                    </div>

                    <nav class="hidden lg:flex items-center text-center text-sm mt-4">
    <a title="@lucasxciv Blog" href="/"
        class="mx-3 text-base01 hover:text-base1 ">
        Blog
    </a>

    <a title="@lucasxciv About" href="/about"
        class="mx-3 text-base01 hover:text-base1 ">
        About
    </a>

    <a title="@lucasxciv Contact"
       href="https://www.linkedin.com/in/lucasxciv"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        LinkedIn <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>

    <a title="@lucasxciv Contact"
       href="https://github.com/lucasxciv"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        GitHub <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>

    <a title="@lucasxciv Contact"
       href="https://x.com/lucasxciv"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        Twitter <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>

    <a title="@lucasxciv Contact"
       href="https://nostr.lucasxciv.dev"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        Nostr <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>

    <a title="@lucasxciv Contact"
       href="https://stackoverflow.com/users/7435669/lucasxciv"
       target="_blank"
       class="mx-3 text-base01 hover:text-base1">
        Stack Overflow <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup>
    </a>
</nav>

                    <button class="flex justify-center items-center bg-base3 shadow h-10 px-5 rounded-full lg:hidden focus:outline-none mt-4"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-base03 h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-base03 h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="w-auto px-2 pt-6 pb-2 bg-base2 shadow hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="@lucasxciv Blog"
                href="/"
                class="block mt-0 mb-4 text-sm text-base01 hover:text-base1 "
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv About"
                href="/about"
                class="block mt-0 mb-4 text-sm text-base01 hover:text-base1 text-base01 hover:text-base1"
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://www.linkedin.com/in/lucasxciv"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >LinkedIn <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://github.com/lucasxciv"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >GitHub <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://x.com/lucasxciv"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >Twitter <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://nostr.lucasxciv.dev"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >Nostr <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
        <li class="pl-4">
            <a
                title="@lucasxciv Contact"
                href="https://stackoverflow.com/users/7435669/lucasxciv"
                target="_blank"
                class="block mt-0 mb-4 text-sm no-underline text-base01 hover:text-base1"
            >Stack Overflow <sup><i class="fa-solid fa-arrow-up-right-from-square opacity-50"></i></sup></a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-16 px-6">
                
    <h1 class="leading-none mb-2 text-base01">Utilizando PHP 7, MongoDB e Doctrine</h1>

    <p class="text-base0 text-xl md:mt-0">de Oliveira, Lucas  •  September 18, 2016</p>

                        <a
                href="/blog/categories/php"
                title="View posts in php"
                class="inline-block bg-base2 hover:text-base1 leading-loose tracking-wide text-base01 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >php</a>
                    <a
                href="/blog/categories/php7"
                title="View posts in php7"
                class="inline-block bg-base2 hover:text-base1 leading-loose tracking-wide text-base01 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >php7</a>
                    <a
                href="/blog/categories/mongodb"
                title="View posts in mongodb"
                class="inline-block bg-base2 hover:text-base1 leading-loose tracking-wide text-base01 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >mongodb</a>
                    <a
                href="/blog/categories/doctrine"
                title="View posts in doctrine"
                class="inline-block bg-base2 hover:text-base1 leading-loose tracking-wide text-base01 uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >doctrine</a>
            
    <div class="border-b border-base2 mb-10 pb-4 text-base01" v-pre>
        <p>Faz um tempo que estou utilizando PHP com MongoDB e faz um tempo também que vi que tinha uma versão do Doctrine que poderia me ajudar com isso, porém quando tinha visto (ano passado) e fui fazer uns testes tive alguns problemas por ainda estar na versão BETA, esses dias resolvi olhar novamente e vi que já faz alguns meses que a versão 1.0 foi lançada e que está até na versão 1.1, então decidi fazer uns testes novamente e compartilhar aqui no blog.</p>

<p>Nesse post vou dar uma introdução de como trabalhar com PHP e MongoDB utilizando o framework de persistência Doctrine ODM. Como exemplo, vou desenvolver um blog simples com posts e comentários, estarei mostrando aqui apenas os códigos da API que estão relacionados com o Doctrine, porém todo o código da aplicação estará disponível e um <a href="http://github.com/deoliveiralucas/blog-php-mongodb-doctrine">repositório no GitHub</a> com um cliente Ajax consumindo a API. Vou utilizar também algumas ferramentas a mais apenas para agilizar o desenvolvimento, como, o micro-framework Silex e o tamplate engine Twig, mas o mesmo procedimento poderá ser facilmente implementado em outros <em>frameworks</em> ou até mesmo em aplicações que utilizam "apenas PHP".</p>

<p>Sendo assim, o blog deverá ter os seguintes recursos na API:</p>

<pre><code class="language-txt">- [POST] /api/post               // Inserir post
- [GET]  /api/post               // Listar dados os posts
- [GET]  /api/post/{id}          // Retornar um post
- [POST] /api/post/{id}/comment  // Inserir comentário no post

- Obs: todos os posts e comentários deverão ser retornados em ordem decrescente por data de criação.
</code></pre>

<p>Primeiro, vamos entender um pouco o que é o Doctrine ODM. O Doctrine ODM (Object Document Mapper) é um framework que foi desenvolvido para o PHP 5.3.0+ e provê uma forma mais transparente de persistir objetos do PHP no MongoDB. Quem já utilizou o Doctrine ORM (Object Relational Mapper), pode ter uma facilidade maior para entender a versão para trabalhar com MongoDB, porém é importante também ter conhecimento especificamente sobre o banco de dados para que se possa utilizar da melhor forma tanto o <em>framework</em> quanto as vantagens que o MongoDB oferece. Caso não conheça e tenha interesse em aprender sobre MongoDB, atualmente existem vários cursos na internet que podem ajudar, porém dois dos que eu fiz, que são gratuitos e que me ajudaram muito, foi o da <a href="http://webschool.io/">Webschool</a> e o da <a href="https://university.mongodb.com/">MongoDB University</a>.</p>

<p>Antes de iniciar o desenvolvimento é necessário ter as seguintes ferramentas instaladas:</p>

<ul>
<li>PHP - Minha versão: 7.1.0</li>
<li>Composer - Minha versão: 1.1.2</li>
<li>MongoDB - Minha versão: 3.0.7 / testei também na versão 3.2.9</li>
</ul>

<p>Logo em seguida é preciso baixar e configurar o Driver do MongoDB para PHP:</p>

<ul>
<li><p>No Windows o download da extensão pode ser feito no <a href="https://pecl.php.net/package/mongodb">site do pecl</a>, depois de ter feito o download, o arquivo <code>.dll</code> deve ser adicionado na pasta <code>ext</code> do PHP e a linha <code>extension=php_mongodb.dll</code> deve ser adicionada no <code>php.ini</code>.</p></li>
<li><p>No Linux o driver pode ser instalado utilizando o <code>pecl</code>, conforme o descrito no repositório do <a href="https://github.com/mongodb/mongo-php-library">mongo-php-library</a>.</p></li>
</ul>

<p>Para verificar se a extensão está instalada, digite o comando <code>php -m</code> no terminal para mostrar a lista de extensões habilitadas, nessa lista deve aparecer <code>mongodb</code>.</p>

<p>Com as ferramentas instaladas e o driver configurado, podemos criar a pasta para iniciar o projeto, no meu caso chamarei de <code>doctrine-odm-blog</code>, feito isso, é necessário criar o arquivo composer.json para instalar as dependências. O arquivo deverá ficar parecido o JSON a seguir.</p>

<pre><code class="language-json">{
    "name": "deoliveiralucas/doctrine-odm-blog",
    "description": "Blog simples com Doctrine ODM e Silex",
    "require": {
        "alcaeus/mongo-php-adapter": "^1.0",
        "doctrine/mongodb": "^1.3",
        "doctrine/mongodb-odm": "^1.1",
        "silex/silex": "^2.0",
        "twig/twig": "~1.0"
    },
    "autoload": {
        "psr-4": {
            "DOLucas\\": "src/"
        }
    },
    "authors": [
        {
            "name": "Lucas de Oliveira",
            "email": "contato@deoliveiralucas.net"
        }
    ]
}
</code></pre>

<p>Note que adicionei também a biblioteca <code>alcaeus/mongo-php-adapter</code>, pelo fato da versão atual do Doctrine ODM (1.3) não suportar a nova versão da extensão do MongoDB para PHP é necessário a instalação desse <em>adapter</em> para que o <em>framework</em> funcione normalmente.</p>

<p>Agora posso instalar as dependências, talvez seja necessário utilizar o parâmetro <code>--ignore-platform-reqs</code>, pois justamente por essa incompatibilidade o Composer pode barrar a instalação:</p>

<pre><code class="language-txt">$ composer install --ignore-platform-reqs
</code></pre>

<p>Depois de instalado, criei mais algumas pastas e arquivos para que a estrutura fique conforme o lista a seguir, lembrando que o objetivo aqui será mostrar apenas os arquivos que estão na pasta <code>Document</code>, <code>Repository</code> e <code>Service</code>.</p>

<pre><code class="language-txt"> |-public
   |-assets
   |-index.php
 |-src
   |-Blog
     |-Controller
       |-PostController.php
     |-Document
       |-Comment.php
       |-Post.php
     |-Factory
       |-CommentFactory.php
       |-PostFactory.php
     |-Repository
       |-PostRepository.php
     |-Service
       |-PostService.php
 |-res
   |-views
     |-create.twig
     |-index.twig
     |-layout.twig
     |-post.twig
 |-vendor
 |-bootstrap.php
 |-composer.json
 |-composer.lock
</code></pre>

<p>Agora vou adicionar o <em>script</em> no arquivo <code>bootstrap.php</code> para criar a conexão com o banco de dados e configurar onde será salvo as classes de <em>Proxies</em> e <em>Hydrators</em> gerados pelo <em>Doctrine</em>, no meu caso deixarei a pasta <code>/tmp</code> e o nome do banco <code>doctrineblog</code>, caso não seja configurado o nome do banco utilizando o método <code>$config-&gt;setDefaultDB</code>, por padrão será criado com o nome <code>doctrine</code>.</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ . '/vendor/autoload.php';

use Silex\Application;
use Silex\Provider\TwigServiceProvider;
use Doctrine\MongoDB\Connection;
use Doctrine\ODM\MongoDB\Configuration;
use Doctrine\ODM\MongoDB\DocumentManager;
use Doctrine\ODM\MongoDB\Mapping\Driver\AnnotationDriver;

$app = new Application();
$app['debug'] = true;

$app-&gt;register(new TwigServiceProvider(), [
    'twig.path' =&gt; __DIR__ . '/res/views',
]);

// Início da configuração do Doctrine
AnnotationDriver::registerAnnotationClasses();

$config = new Configuration();
$config-&gt;setProxyDir('/tmp');
$config-&gt;setProxyNamespace('Proxies');
$config-&gt;setHydratorDir('/tmp');
$config-&gt;setHydratorNamespace('Hydrators');
$config-&gt;setMetadataDriverImpl(AnnotationDriver::create('/tmp'));
$config-&gt;setDefaultDB('doctrineblog');

$dm = DocumentManager::create(new Connection(), $config);
</code></pre>

<p>No caso acima, a conexão está sendo feita com um banco de dados local, para conectar com um banco remoto, a linha para criar o <code>DocumentManager</code> deve estar da seguinte forma:</p>

<pre><code class="language-php">&lt;?php
$server = "mongodb://user:pass@server:port/dbname";

$dm = DocumentManager::create(new Connection($server), $config);
</code></pre>

<p>Depois de ter criado a conexão, vou criar os arquivos responsáveis por mapear os objetos da minha aplicação com as coleções do banco de dados, assim como no Doctrine ORM é possível fazer isso de forma simples utilizando as anotações, XML ou YAML, nesse exemplo estarei utilizando anotações. Para que as anotações funcionem é necessário que importe a classe <code>Annotations</code> (no caso abaixo foi dado um apelido <code>ODM</code>) e depois informe ao Doctrine que a classe que está sendo criada é um documento do MongoDB com a anotação <code>@ODM\Document</code>, posso informar também qual o nome da coleção que deverá ser armazenado esse documento passando como parâmetro o nome da coleção <code>@ODM\Document(collection="posts")</code>, caso não informe o nome da coleção, ele será criado com o mesmo nome da classe, em seguida posso criar os campos do documento utilizando as anotações.</p>

<p>Como um <em>post</em> deve ter vários comentários é importante destacar o atributo <code>$comments</code> onde está dizendo que deverá referenciar vários documentos (<code>ReferenceMany</code>) utilizando a estratégia (<code>strategy</code>) <code>set</code> que é um comando do MongoDB, o documento alvo (<code>targetDocument</code>) que será referenciado dentro dessa lista é o <code>Comment</code> (uma classe que deverá ser criada), qualquer operação executada no documento pai (<code>Post</code>) poderá refletir nos documentos filhos (<code>Comment</code>) utilizando o parâmetro <code>cascade="all"</code> (<a href="http://docs.doctrine-project.org/projects/doctrine-mongodb-odm/en/latest/reference/reference-mapping.html#cascading-operations">esse opção pode ser personalizada</a>) e por fim, conforme descrito no início do <em>post</em> os comentários retornados deverão estar em ordem decrescente pela data de criação, para isso usamos o parâmetro <code>sort={"createdAt": "desc"}</code>.</p>

<p>Sendo assim, a classe <code>Post</code> deve ficar da seguinte forma:</p>

<pre><code class="language-php">&lt;?php

namespace DOLucas\Blog\Document;

use Doctrine\ODM\MongoDB\Mapping\Annotations as ODM;
use DateTime;

/**
 * @ODM\Document(collection="posts")
 */
class Post
{

    /**
     * @ODM\Id
     */
    private $id;

    /**
     * @ODM\Field(type="string")
     */
    private $title;

    /**
     * @ODM\Field(type="string")
     */
    private $body;

    /**
     * @ODM\Field(type="string")
     */
    private $author;

    /**
     * @ODM\ReferenceMany(
     *    strategy="set",
     *    targetDocument="Comment",
     *    cascade="all",
     *    sort={"createdAt": "desc"}
     * )
     */
    private $comments = [];

    /**
     * @ODM\Field(type="date")
     */
    private $createdAt;

    /**
     * @param string $title
     * @param string $body
     * @param string $author
     */
    public function __construct(string $title, string $body, string $author)
    {
        $this-&gt;setTitle($title);
        $this-&gt;setBody($body);
        $this-&gt;setAuthor($author);
        $this-&gt;setCreatedAt(new DateTime());
    }

    /**
     * @return string
     */
    public function getId() : string
    {
        return $this-&gt;id;
    }

    /**
     * @param string $title
     */
    private function setTitle(string $title)
    {
        $this-&gt;title = $title;
    }

    /**
     * @return string
     */
    public function getTitle() : string
    {
        return $this-&gt;title;
    }

    /**
     * @param string $body
     */
    private function setBody(string $body)
    {
        $this-&gt;body = $body;
    }

    /**
     * @return string
     */
    public function getBody() : string
    {
        return $this-&gt;body;
    }

    /**
     * @param string $author
     */
    private function setAuthor(string $author)
    {
        $this-&gt;author = $author;
    }

    /**
     * @return string
     */
    public function getAuthor() : string
    {
        return $this-&gt;author;
    }

    /**
     * @param Comment $comment
     */
    public function addComment(Comment $comment)
    {
        $this-&gt;comments[] = $comment;
    }

    /**
     * @return array
     */
    public function getComments() : array
    {
        return $this-&gt;comments-&gt;toArray();
    }

    /**
     * @param DateTime
     */
    private function setCreatedAt(DateTime $createdAt)
    {
        $this-&gt;createdAt = $createdAt;
    }

    /**
     * @return DateTime
     */
    public function getCreatedAt() : DateTime
    {
        return $this-&gt;createdAt;
    }
}
</code></pre>

<p>Depois vou mapear a classe <code>Comment</code>:</p>

<pre><code class="language-php">&lt;?php

namespace DOLucas\Blog\Document;

use Doctrine\ODM\MongoDB\Mapping\Annotations as ODM;
use DateTime;

/**
 * @ODM\Document(collection="comments")
 */
class Comment
{

    /**
     * @ODM\Id
     */
    private $id;

    /**
     * @ODM\Field(type="string")
     */
    private $username;

    /**
     * @ODM\Field(type="string")
     */
    private $comment;

    /**
     * @ODM\Field(type="date")
     */
    private $createdAt;

    /**
     * @return string
     */
    public function getId() : string
    {
        return $this-&gt;id;
    }

    /**
     * @param string $title
     */
    public function setTitle(string $title)
    {
        $this-&gt;title = $title;
    }

    /**
     * @param string $username
     */
    public function setUsername(string $username)
    {
        $this-&gt;username = $username;
    }

    /**
     * @return string
     */
    public function getUsername() : string
    {
        return $this-&gt;username;
    }

    /**
     * @param string $comment
     */
    public function setComment(string $comment)
    {
        $this-&gt;comment = $comment;
    }

    /**
     * @return string
     */
    public function getComment() : string
    {
        return $this-&gt;comment;
    }

    /**
     * @param DateTime
     */
    public function setCreatedAt(DateTime $createdAt)
    {
        $this-&gt;createdAt = $createdAt;
    }

    /**
     * @return DateTime
     */
    public function getCreatedAt() : DateTime
    {
        return $this-&gt;createdAt;
    }
}
</code></pre>

<p>Agora que temos nossas classes mapeadas com o banco de dados já é possível utilizá-las, para isso poderíamos fazer da seguinte forma para armazenar e retornar os <em>posts</em> do banco de dados, utilizando o <code>$dm</code> que é o <em>DocumentManager</em> criado no arquivo <code>bootstrap.php</code>:</p>

<pre><code class="language-php">&lt;?php

// criar o post
$post = new Post('Titulo do Post', 'Descrição do post', '@deoliveiralucas');

// avisa ao Doctrine para armazenar o post no próximo flush()
$dm-&gt;persist($post);

// amazena post
$dm-&gt;flush();

// para retornar os posts
$posts = $this-&gt;dm-&gt;getRepository(Post::class)-&gt;findAll();
</code></pre>

<p>Mas para que fique algo mais organizado, criei uma classe chamada <code>PostRepostory</code> que recebe o <em>DocumentManager</em> no construtor. Para realizar as consultas vou utilizar a <a href="http://docs.doctrine-project.org/projects/doctrine-mongodb-odm/en/latest/reference/query-builder-api.html#query-builder-api">Query Builder API</a> que possibilita criar consultas mais personalizadas, pois será necessário retornar o <em>posts</em> em ordem decrescente por data de criação.</p>

<p>Então, a classe <code>PostRepository</code> deve ficar da seguinte forma:</p>

<pre><code class="language-php">&lt;?php

namespace DOLucas\Blog\Repository;

use DOLucas\Blog\Document\Post;
use Doctrine\ODM\MongoDB\DocumentManager;
use Doctrine\ODM\MongoDB\Cursor;

/**
 * @author Lucas de Oliveira &lt;contato@deoliveiralucas.net&gt;
 */
class PostRepository
{

    /**
     * @var DocumentManager
     */
    private $dm;

    /**
     * @var \Doctrine\Common\Persistence\ObjectRepository
     */
    private $queryBuilder;

    /**
     * @param DocumentManager $dm
     */
    public function __construct(DocumentManager $dm)
    {
        $this-&gt;dm = $dm;
        $this-&gt;queryBuilder = $dm-&gt;createQueryBuilder(Post::class);
    }

    /**
     * @param Post $post
     */
    public function save(Post $post)
    {
        $this-&gt;dm-&gt;persist($post);
        $this-&gt;dm-&gt;flush();
    }

    /**
     * @return Cursor
     */
    public function getAll() : Cursor
    {
        return $this
            -&gt;queryBuilder
            -&gt;sort('createdAt', 'desc')
            -&gt;getQuery()
            -&gt;execute();
    }

    /**
     * @param string $id
     * @return Post
     */
    public function getById(string $id) : Post
    {
        return $this
            -&gt;queryBuilder
            -&gt;field('_id')-&gt;equals($id)
            -&gt;getQuery()
            -&gt;getSingleResult();
    }
}
</code></pre>

<p>Com a classe <em>repository</em> e os <em>documents</em> prontos, vou criar mais uma classe chamada <code>PostService</code> que será responsável por inserir as informações que vem da requisição no banco de dados utilizando as classes criadas anteriormente e utilizar o método <code>toArray</code> para mostrar os dados de forma mais limpa na API. Adicionei também as classes <em>Factories</em> que é responsável por instanciar os <em>documents</em> e os <em>Validators</em>. Então a classe <code>PostService</code> com todos os métodos que precisamos, ficou da seguinte maneira:</p>

<pre><code class="language-php">&lt;?php

namespace DOLucas\Blog\Service;

use DOLucas\Blog\Repository\PostRepository;
use DOLucas\Blog\Factory\PostFactory;
use DOLucas\Blog\Factory\CommentFactory;
use DOLucas\Blog\Document\Post;
use DOLucas\Blog\Validator\PostValidator;
use DOLucas\Blog\Validator\CommentValidator;
use Doctrine\ODM\MongoDB\Cursor;
use InvalidArgumentException as ArgumentException;

/**
 * @author Lucas de Oliveira &lt;contato@deoliveiralucas.net&gt;
 */
class PostService
{

    /**
     * @var PostRepository
     */
    private $repository;

    /**
     * @var PostFactory
     */
    private $postFactory;

    /**
     * @var CommentFactory
     */
    private $commentFactory;

    /**
     * @var PostValidator
     */
    private $postValidator;

    /**
     * @var CommentValidator
     */
    private $commentValidator;

    /**
     * @param PostRepository $postRepository
     * @param PostFactory $postFactory
     * @param CommentFactory $commentFactory
     * @param PostValidator $postValidator
     * @param CommentValidator $commentValidator
     */
    public function __construct(
        PostRepository $postRepository,
        PostFactory $postFactory,
        CommentFactory $commentFactory,
        PostValidator $postValidator,
        CommentValidator $commentValidator
    ) {
        $this-&gt;repository = $postRepository;
        $this-&gt;postFactory = $postFactory;
        $this-&gt;commentFactory = $commentFactory;
        $this-&gt;postValidator = $postValidator;
        $this-&gt;commentValidator = $commentValidator;
    }

    /**
     * @param array $params
     */
    public function create(array $params) : array
    {
        try {
            $this-&gt;postValidator-&gt;validate($params);

            $post = $this-&gt;postFactory-&gt;create(
                $params['title'],
                $params['body'],
                $params['author']
            );

            $this-&gt;repository-&gt;save($post);

            return [
                'status'  =&gt; 'success',
                'message' =&gt; 'Post inserido com sucesso'
            ];
        } catch (ArgumentException $e) {
            return [
                'status'  =&gt; 'error',
                'message' =&gt; $e-&gt;getMessage()
            ];
        } catch (Exception $e) {
            return [
                'status'   =&gt; 'error',
                'message'  =&gt; 'Ocorreu um problema ao inserir novo post',
                'internal' =&gt; $e-&gt;getMessage()
            ];
        }
    }

    /**
     * @return array
     */
    public function getAll() : array
    {
        return $this-&gt;toArray($this-&gt;repository-&gt;getAll());
    }

    /**
     * @param string $idPost
     * @return array
     */
    public function getById(string $idPost) : array
    {
        return $this-&gt;toArray($this-&gt;repository-&gt;getById($idPost));
    }

    /**
     * @param string $idPost
     * @param array $params
     * @return array
     */
    public function addComment(string $idPost, array $params) : array
    {
        try {
            $this-&gt;commentValidator-&gt;validate($params);

            $post = $this-&gt;repository-&gt;getById($idPost);

            $comment = $this-&gt;commentFactory-&gt;create(
                $params['username'],
                $params['comment']
            );

            $post-&gt;addComment($comment);

            $this-&gt;repository-&gt;save($post);

            return [
                'status'  =&gt; 'success',
                'message' =&gt; 'Comentário adicionado com sucesso'
            ];
        } catch (ArgumentException $e) {
            return [
                'status'  =&gt; 'error',
                'message' =&gt; $e-&gt;getMessage()
            ];
        } catch (Exception $e) {
            return [
                'status'   =&gt; 'error',
                'message'  =&gt; 'Ocorreu um problema ao adicionar comentário',
                'internal' =&gt; $e-&gt;getMessage()
            ];
        }
    }

    /**
     * @param array|Post $posts
     * @return array
     */
    public function toArray($posts) : array
    {
        $arrPost = [];

        if ($posts instanceof Cursor) {
            foreach ($posts as $post) {
                $arrPost[] = $this-&gt;postToArray($post);
            }

            return $arrPost;
        }

        if ($posts instanceof Post) {
            return $this-&gt;postToArray($posts);
        }

        return $arrPost;
    }

    /**
     * @param Post $post
     * @return array
     */
    protected function postToArray(Post $post) : array
    {
        return [
            'id'        =&gt; $post-&gt;getId(),
            'title'     =&gt; $post-&gt;getTitle(),
            'body'      =&gt; $post-&gt;getBody(),
            'author'    =&gt; $post-&gt;getAuthor(),
            'createdAt' =&gt; $post-&gt;getCreatedAt(),
            'comments'  =&gt; $this-&gt;commentsToArray($post-&gt;getComments())
        ];
    }

    /**
     * @param array $comments
     * @return array
     */
    protected function commentsToArray(array $comments) : array
    {
        $arrComments = [];
        foreach ($comments as $comment) {
            $arrComments[] = [
                'id'        =&gt; $comment-&gt;getId(),
                'username'  =&gt; $comment-&gt;getUsername(),
                'comment'   =&gt; $comment-&gt;getComment(),
                'createdAt' =&gt; $comment-&gt;getCreatedAt()
            ];
        }
        return $arrComments;
    }
}
</code></pre>

<p>O código completo da aplicação está disponível nesse link: <a href="http://github.com/deoliveiralucas/blog-php-mongodb-doctrine">http://github.com/deoliveiralucas/blog-php-mongodb-doctrine</a>.</p>

<p>Podemos ver a facilidade que o Doctrine nos oferece para trabalhar com MongoDB, mas vale ressaltar também que essa facilidade pode trazer uma pouco de perda performance quando comparado com a utilização apenas das classes da extensão do PHP, que também é simples de utilizar.</p>

<p>Eu particularmente já desenvolvi projetos que usam PHP com MongoDB, mas ainda não utilizei o Doctrine ODM pelo motivo de que quando fui pesquisar ainda estava na versão BETA e não quis arriscar, mas se atualmente eu fosse começar um novo projeto, com certeza daria uma atenção maior a esse <em>framework</em>.</p>

<p>A fonte principal desse <em>post</em> foi a documentação oficial do Doctrine ODM, caso queira saber mais recomendo que acesse, pois está bem completa:  <a href="http://docs.doctrine-project.org/projects/doctrine-mongodb-odm/en/latest/">http://docs.doctrine-project.org/projects/doctrine-mongodb-odm/en/latest/</a>.</p>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://lucasxciv.dev/blog/2016-02-13-instanciacao-de-variaveis-no-javascript" title="Older Post: Instanciação de variáveis no JavaScript" class="text-base01 hover:text-base1">
                    &LeftArrow; Instanciação de variáveis no JavaScript
                </a>
                    </div>

        <div>
                            <a href="https://lucasxciv.dev/blog/2019-03-19-dicas-para-iniciar-um-projeto-em-php" title="Newer Post: Dicas para iniciar um projeto em PHP" class="text-base01 hover:text-base1">
                    Dicas para iniciar um projeto em PHP &RightArrow;
                </a>
                    </div>
    </nav>

    <hr />
    <script src="https://giscus.app/client.js"
            data-repo="lucasxciv/lucasxciv.github.io"
            data-repo-id="MDEwOlJlcG9zaXRvcnk0NzYxOTYwMw=="
            data-category="Comments"
            data-category-id="DIC_kwDOAtaeE84CjAD7"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="noborder_light"
            data-lang="en"
            crossorigin="anonymous"
            async>
    </script>
        </main>

        <footer class="bg-base2 text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; 2015-2024 • <a href="https://lucasxciv.dev" title="@lucasxciv" class="text-base01 hover:text-base1">lucasxciv.dev</a> • All rights reserved.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=e4a964d2b186fcedcfeb820ced60e3fb"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
